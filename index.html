<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Civilytix Dashboard with TomTom Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- TomTom Maps CSS -->
  <link rel="stylesheet" type="text/css" href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.14.0/maps/maps.css">
  <style>
    body {
      background-color: #f0f4f9;
      font-family: Arial, sans-serif;
    }
    .sidebar {
      background-color: #004d66;
      min-height: 100vh;
      color: white;
      padding-top: 20px;
    }
    .sidebar a {
      color: #fff;
      padding: 15px;
      text-decoration: none;
      display: block;
    }
    .sidebar a:hover {
      background-color: #00394d;
    }
    /* Topbar */
    .topbar {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    .topbar input[type="text"] {
      width: 100%;
      padding: 5px;
      border: none;
      border-radius: 5px;
    }
    /* Map container */
    #map {
      width: 100%;
      height: 650px; /* Adjusted height for better visibility */
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 sidebar">
        <h4 class="text-center">Civilytix</h4>
        <a href="#">Home</a>
        <a href="#">Projects</a>
        <a href="#">Bids</a>
        <a href="#">Finances</a>
        <a href="#">Audit Results</a>
        <a href="#">Scheduling</a>
        <a href="#">Training</a>
      </nav>

      <!-- Main Content -->
      <main class="col-md-8">
        <!-- Search bar in Topbar -->
        <div class="topbar">
          <input type="text" placeholder="Search..." id="search-input">
          <button onclick="searchLocation()">Search</button>
        </div>

        <!-- TomTom Map -->
        <div id="map"></div>
      </main>

      <!-- Right Panel -->
      <aside class="col-md-2">
        <!-- Add Marker Inputs -->
        <div class="mt-3">
          <input type="text" id="lat" class="form-control mb-2" placeholder="Latitude">
          <input type="text" id="lon" class="form-control mb-2" placeholder="Longitude">
          <button onclick="addMarker()" class="btn btn-primary btn-block">Add Marker</button>
          <button onclick="createRoute()" class="btn btn-success btn-block">Create Route</button>
          <button onclick="clearMarkers()" class="btn btn-secondary btn-block">Clear Markers</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- TomTom Maps JS -->
  <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.14.0/maps/maps-web.min.js"></script>
  <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.14.0/services/services-web.min.js"></script>
  <script>
    var APIKEY = "pXQeBnDaX0L9POuXZAoMAGF0Vyd2sCby";
    var map = tt.map({
      key: APIKEY,
      container: "map",
      center: [87.3105, 22.3149],
      zoom: 14
    });
    var markers = [];
  
    // Function to add a marker where the user clicks on the map
    map.on('click', function(event) {
      var lngLat = event.lngLat;
      var marker = new tt.Marker().setLngLat(lngLat).addTo(map);
      markers.push(marker);
      map.flyTo({ center: lngLat, zoom: 14 }); // Fly to the clicked marker location
    });
  
    function searchLocation() {
      var query = document.getElementById("search-input").value;
      tt.services.fuzzySearch({
        key: APIKEY,
        query: query
      }).then(function(results) {
        if (results.results.length > 0) {
          var result = results.results[0];
          map.flyTo({
            center: result.position,
            zoom: 14
          });
        } else {
          alert("Location not found.");
        }
      }).catch(function(error) {
        console.error("Search failed:", error);
      });
    }
  
    function addMarker() {
      var lat = parseFloat(document.getElementById("lat").value);
      var lon = parseFloat(document.getElementById("lon").value);
  
      // Validate that latitude and longitude are within acceptable ranges
      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert('Please enter valid latitude and longitude values.');
        return;
      }
  
      // Add marker to the map
      var marker = new tt.Marker().setLngLat([lon, lat]).addTo(map);
      markers.push(marker);
      map.flyTo({ center: [lon, lat], zoom: 14 }); // Fly to the new marker location
    }
  
    function clearMarkers() {
      markers.forEach(marker => marker.remove());
      markers = [];
      if (map.getLayer('route')) {
        map.removeLayer('route');
        map.removeSource('route');
      }
    }
  
    function createRoute() {
      var locations = markers.map(marker => marker.getLngLat());
      if (locations.length > 1) {
        tt.services.calculateRoute({
          key: APIKEY,
          locations: locations,
          travelMode: 'car'
        }).then(function(route) {
          var geoJSON = route.toGeoJson();
          if (map.getLayer('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          map.addLayer({
            id: 'route',
            type: 'line',
            source: {
              type: 'geojson',
              data: geoJSON
            },
            paint: {
              'line-color': 'blue',
              'line-width': 5
            }
          });
        }).catch(function(error) {
          console.error("Route creation failed:", error);
        });
      } else {
        alert("Add more markers to create a route.");
      }
    }
  </script>
  
</body>
</html>
